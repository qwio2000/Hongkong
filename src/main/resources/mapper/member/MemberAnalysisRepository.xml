<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeiglobal.hk.repository.member.MemberAnalysisRepository">
	<select id="findMembersByGrade" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberAnalysisByGrade">
		SELECT a.mgYY, a.mgMM, a.subj, a.gradeCD, globalbiz.FuncCodeDtlNM(a.jisaCD, '0003', a.gradeCD, '', 'Y') AS gradeCDNM, a.membersCnt, a.membersRate
		FROM globalmagam.StatMembersBySchGrade AS a
			INNER JOIN globalbiz.CodeDtl AS b ON b.mstCD = '0003' AND a.gradeCD = b.dtlCD AND b.jisaCD = #{jisaCD}
		WHERE a.jisaCD = #{jisaCD} AND a.deptCD = #{deptCD} AND a.subj = #{subj} AND a.mgYYMM = #{searchYYMM}
		ORDER BY b.sortVal1 ASC
	</select>
	<select id="findMembersByWbGrade" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberByGrade">
		SELECT subj, wbGrade, subjCnt, subjRate
		FROM (
			SELECT subj, wbGrade, subjCnt, subjRate, '1' AS sort
			FROM globalmagam.StatSubjByGrade 
			WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj = #{subj} AND mgYYMM = #{searchYYMM}
			UNION
			SELECT subj, 'Total', SUM(subjCnt) AS subjCnt, '100.00', '0'
			FROM globalmagam.StatSubjByGrade 
			WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj = #{subj} AND mgYYMM = #{searchYYMM}
		) AS a
		ORDER BY sort, wbGrade
	</select>
	<select id="findMemberByMonths" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberByMonthFA">
		SELECT mgYY, mgMM, '', memBegin, memNew, memDrop, memNet, memEnd, 
			FORMAT(IFNULL(memNew / memBegin * 100, 0.00), 2) AS memNewRate, 
			FORMAT(IFNULL(memDrop / memBegin * 100, 0.00), 2) AS memDropRate
		FROM globalmagam.SalesCenters 
		WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj = 'TT' AND mgYYMM BETWEEN #{beforeYYMM} AND #{searchYYMM}
		ORDER BY mgYYMM
	</select>
	<select id="findMemberBySubject" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberBySubject">
		SELECT subj, subjEnd, FORMAT(IFNULL(subjEnd / b.subjEndSum * 100, 0.00), 2) AS subjRatio, b.subjEndSum
		FROM (
			SELECT jisaCD, deptCD, mgYYMM, subj, subjEnd
			FROM globalmagam.SalesCenters 
			WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj != 'TT' AND mgYYMM = #{searchYYMM}
			GROUP BY subj
		) AS a 
			INNER JOIN (
				SELECT jisaCD, deptCD, mgYYMM, SUM(subjEnd) AS subjEndSum
				FROM globalmagam.SalesCenters 
				WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj != 'TT' AND mgYYMM = #{searchYYMM}
		) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD AND a.mgYYMM = b.mgYYMM
	</select>
	<select id="findMembersByMultiSubj" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberByMultiSubj">
		SELECT b.deptName, multi1+multi2+multi3+multi4+multi5+multi6 AS monthSale, multi1, multi1Rate, multi2, multi2Rate, multi3, multi3Rate, multi4, multi4Rate, multi5, multi5Rate, multi6, multi6Rate
		FROM globalbiz.DeptMst AS b
			LEFT JOIN globalmagam.StatMembersByMultiSubj AS a ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD AND a.subj = #{subj} AND a.mgYYMM = #{searchYYMM}
		WHERE b.jisaCD = #{jisaCD} AND b.deptCD = #{deptCD}
	</select>
	<select id="findDeptSearchPop" parameterType="java.lang.String" resultType="hashMap">
		SELECT jisaCD, deptCD, deptName, stateName
		FROM globalbiz.ViewsDeptMst
		WHERE jisaCD = #{jisaCD} AND statusCD = '1' AND deptCD != '00000'
		ORDER BY stateName, deptName
	</select>
	<select id="findMembersByMonthsJA" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberByMonthFA">
		SELECT mgYY, mgMM, '', memBegin, memNew, memDrop, memNet, memEnd, 
			FORMAT(IFNULL(memNew / memBegin * 100, 0.00), 2) AS memNewRate, 
			FORMAT(IFNULL(memDrop / memBegin * 100, 0.00), 2) AS memDropRate
		FROM globalmagam.SalesJisa
		WHERE jisaCD = #{jisaCD} AND deptCD = '00000' AND subj = 'TT' AND mgYYMM BETWEEN #{beforeYYMM} AND #{searchYYMM}
		ORDER BY mgYYMM
	</select>
	<select id="findMemberBySubjectJA" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberBySubject">
		SELECT subj, subjEnd, FORMAT(IFNULL(subjEnd / b.subjEndSum * 100, 0.00), 2) AS subjRatio, b.subjEndSum
		FROM (
			SELECT jisaCD, deptCD, mgYYMM, subj, subjEnd
			FROM globalmagam.SalesJisa 
			WHERE jisaCD = #{jisaCD} AND deptCD = '00000' AND subj != 'TT' AND mgYYMM = #{searchYYMM}
			GROUP BY subj
		) AS a 
			INNER JOIN (
				SELECT jisaCD, deptCD, mgYYMM, SUM(subjEnd) AS subjEndSum
				FROM globalmagam.SalesJisa 
				WHERE jisaCD = #{jisaCD} AND deptCD = '00000' AND subj != 'TT' AND mgYYMM = #{searchYYMM}
		) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD AND a.mgYYMM = b.mgYYMM
	</select>
	<select id="findSubjectReport" statementType="CALLABLE" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$SubjectReport">
		CALL globalmagam.SPStatProgBySubj(#{jisaCD}, #{deptCD}, #{searchYY}, '')
	</select>
	<select id="findSubjReportBottom" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$SubjectReportBottom">
		SELECT *
		FROM (
			SELECT DATE_FORMAT(CONCAT(mgYYMM,'-01'), '%Y/%m') AS mgYYMM, a.deptCD, c.deptName, IFNULL(d.stateName, '') AS stateName, globalmagam.FuncDeptSubjReport(a.jisaCD, a.deptCD, #{searchYYMM}, '1', #{totalFlag}) AS subjReport, b.totEnd, 1 AS sort
			FROM globalmagam.SalesCenters AS a
			INNER JOIN globalbiz.DeptMst AS c ON a.jisaCD = c.jisaCD AND a.deptCD = c.deptCD
			LEFT JOIN globalbiz.StateInfo AS d ON c.jisaCD = d.jisaCD AND c.stateCD = d.stateCD
				LEFT JOIN (
					SELECT jisaCD, deptCD, SUM(subjEnd) AS totEnd
					FROM globalmagam.SalesCenters
					WHERE mgYYMM = #{searchYYMM}
					GROUP BY mgYYMM, deptCD
				) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD
			WHERE a.jisaCD = #{jisaCD} AND a.mgYYMM = #{searchYYMM}
			<if test="deptCD != null and deptCD != '00000'">
				AND a.deptCD = #{deptCD}
			</if>
			GROUP BY a.deptCD
			UNION
			SELECT DATE_FORMAT(CONCAT(mgYYMM,'-01'), '%Y/%m') AS mgYYMM, 'Total', 'Total', 'Total', globalmagam.FuncDeptSubjReport(a.jisaCD, a.deptCD, #{searchYYMM}, '2', #{totalFlag}) AS subjReport, b.totEnd, 2 AS sort
			FROM globalmagam.SalesCenters AS a
				LEFT JOIN (
					SELECT jisaCD, deptCD, SUM(subjEnd) AS totEnd
					FROM globalmagam.SalesCenters
					WHERE mgYYMM = #{searchYYMM}
					<if test="totalFlag == '1'.toString()">
					GROUP BY mgYYMM, jisaCD
					</if>
					<if test="totalFlag == '2'.toString()">
					GROUP BY mgYYMM, jisaCD, deptCD
					</if>
				) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD
			WHERE a.jisaCD = #{jisaCD} AND a.mgYYMM = #{searchYYMM}
			<if test="deptCD != null and deptCD != '00000'">
				AND a.deptCD = #{deptCD}
			</if>
			GROUP BY a.jisaCD
		) AS result
		ORDER BY sort, deptCD
	</select>
	<select id="findSubjReportBottomSub" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$SubjectReportBottomSub">
		SELECT DATE_FORMAT(CONCAT(mgYYMM,'-01'), '%Y/%m') AS mgYYMM, a.deptCD, globalmagam.FuncDeptSubjReport(a.jisaCD, a.deptCD, #{subYYMM}, '1', '') AS subjReport, b.totEnd
		FROM globalmagam.SalesCenters AS a
			LEFT JOIN (
				SELECT jisaCD, deptCD, SUM(subjEnd) AS totEnd
				FROM globalmagam.SalesCenters
				WHERE mgYYMM = #{subYYMM}
				GROUP BY mgYYMM, deptCD
			) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD
		WHERE a.jisaCD = #{jisaCD} AND a.deptCD = #{deptCD} AND mgYYMM = #{subYYMM}
		GROUP BY a.deptCD
		ORDER BY a.deptCD
	</select>
</mapper>