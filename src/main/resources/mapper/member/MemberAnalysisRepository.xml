<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeiglobal.hk.repository.member.MemberAnalysisRepository">
	<select id="findMemberAnalysisByGradeCount" parameterType="com.jeiglobal.hk.domain.auth.LoginInfo" resultType="int">
		SELECT COUNT(*)
		FROM
			(
			SELECT a.memKey, a.gradeCD, COUNT(1)
			FROM globalbiz.MemMst AS a
				INNER JOIN globalbiz.MemSubjMst AS b ON a.memKey = b.memKey AND b.statusCD = '1'
			WHERE b.jisaCD = #{jisaCD} AND b.deptCD = #{deptCD}
			GROUP BY a.memKey
			) AS a
	</select>
	<select id="findMemberAnalysisByGrade" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberAnalysisByGrade">
		SELECT dtlCD, dtlCDNM, COUNT(b.memKey) AS countOfGrades, FORMAT(COUNT(b.memKey) / #{totCount} * 100, 2) AS ratio
		FROM globalbiz.CodeDtl AS a
			LEFT JOIN (
				SELECT a.memKey, a.gradeCD
				FROM globalbiz.MemMst AS a
					INNER JOIN globalbiz.MemSubjMst AS b ON a.memKey = b.memKey AND b.statusCD = '1'
				WHERE b.jisaCD = #{jisaCD} AND b.deptCD = #{deptCD}
				GROUP BY a.memKey
				) AS b ON a.dtlCD = b.gradeCD
		WHERE a.jisaCD = #{jisaCD} AND a.mstCD = '0003'
		GROUP BY a.dtlCD
		ORDER BY a.sortVal1 ASC
	</select>
	<select id="findMemberByMonths" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberByMonthFA">
		SELECT mgYY, mgMM, '', memBegin, memNew, memDrop, memNet, memEnd, 
			FORMAT(IFNULL(memNew / memBegin * 100, 0.00), 2) AS memNewRate, 
			FORMAT(IFNULL(memDrop / memBegin * 100, 0.00), 2) AS memDropRate
		FROM globalmagam.SalesCenters 
		WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj = 'TT' AND mgYYMM BETWEEN #{beforeYYMM} AND #{searchYYMM}
		ORDER BY mgYYMM
	</select>
	<select id="findMemberBySubject" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberAnalysisDto$MemberBySubject">
		SELECT subj, subjEnd, FORMAT(IFNULL(subjEnd / b.subjEndSum * 100, 0.00), 2) AS subjRatio, b.subjEndSum
		FROM (
			SELECT jisaCD, deptCD, mgYYMM, subj, subjEnd
			FROM globalmagam.SalesCenters 
			WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj != 'TT' AND mgYYMM = #{searchYYMM}
			GROUP BY subj
		) AS a 
			INNER JOIN (
				SELECT jisaCD, deptCD, mgYYMM, SUM(subjEnd) AS subjEndSum
				FROM globalmagam.SalesCenters 
				WHERE jisaCD = #{jisaCD} AND deptCD = #{deptCD} AND subj != 'TT' AND mgYYMM = #{searchYYMM}
		) AS b ON a.jisaCD = b.jisaCD AND a.deptCD = b.deptCD AND a.mgYYMM = b.mgYYMM
	</select>
</mapper>