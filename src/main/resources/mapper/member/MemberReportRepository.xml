<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeiglobal.hk.repository.member.MemberReportRepository">
	<select id="findSearchResults" statementType="CALLABLE" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberDto$MemberSearchInfo">
	CALL SPMemberSearchList(#{loginInfo.jisaCD},#{loginInfo.deptCD},'','','','',
	#{memberSearch.memberStatus},#{memberSearch.lastName},#{memberSearch.firstName},#{memberSearch.homePhone},
	#{memberSearch.cellPhone},#{memberSearch.email},#{memberSearch.grade},#{memberSearch.subject},#{memberSearch.classDay},
	#{memberSearch.orderBy},#{memberSearch.direction},#{pageNum},#{pageSize})
	</select>
	<select id="findMemMstByMemKey" parameterType="java.lang.String" resultType="com.jeiglobal.hk.domain.member.MemMst">
	SELECT memKey, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, 
		stateCD, zip, addr, gEmail, gPhone, gCellPhone, registWhy, registWhyEtc, registHow, registHowEtc, remarks, regDate, 
		regID, updDate, updID
	FROM globalbiz.MemMst
	WHERE memKey = #{memKey}
	</select>
	<select id="findMemMstsByGuardianName" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberDto$MemberReportInfo">
	SELECT a.memKey, a.mFstName, a.mLstName, a.mBirthDay, a.gradeCD, globalbiz.FuncCodeDtlNM(b.jisaCD,'0003',a.gradeCD,'','Y') AS gradeName, 
		a.schoolName, a.mEmail, a.eContact, a.ePhone, a.remarks, a.regDate, MIN(b.StatusCD) AS statusCD, 
		globalbiz.FuncCodeDtlNM(b.jisaCD,'0008',MIN(b.statusCD),'','Y') AS statusName
	FROM globalbiz.MemMst AS a 
		INNER JOIN globalbiz.MemSubjMst AS b ON a.memKey = b.memKey
	WHERE gFstName = #{gFstName} AND gLstName = #{gLstName} AND b.jisaCD = #{jisaCD} 
	<if test="deptCD != '00000'">
		AND b.deptCD = #{deptCD}
	</if>
	GROUP BY a.memKey
	ORDER BY a.memKey
	</select>
	<select id="findMemSubjMstsByMemKey" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemberDto$MemberReportSubjInfo">
	SELECT a.memKey, a.subj, a.statusCD, b.yoil, globalbiz.FuncCodeDtlNM(a.jisaCD, '0006', b.yoil, 'E', 'Y') AS yoilName, a.registFstYMD, 
		a.registFnlYMD, CASE a.registFnlYMD WHEN '' THEN a.registFstYMD ELSE a.registFnlYMD END AS recentRegistFnlYMD, 
		DATE_FORMAT(CASE a.registFnlYMD WHEN '' THEN a.registFstYMD ELSE a.registFnlYMD END, '%m/%d/%Y') AS convertRegistYMD, 
		a.dropFnlYMD, IFNULL(DATE_FORMAT(a.dropFnlYMD, '%m/%d/%Y'), '') AS convertDropYMD, b.visitHours, 
		globalbiz.FuncCodeDtlNM(a.jisaCD, '0206' , b.visitHours, '', 'Y') AS visitHourName, c.digYN, a.jisaCD, IFNULL(d.omrDate, '') AS omrDate
	FROM globalbiz.MemSubjMst AS a 
	INNER JOIN globalbiz.MemSubjStudy AS b ON a.memKey = b.memKey AND a.subj = b.subj
	INNER JOIN globalbiz.DeptSubjInfo AS c ON a.jisaCD = c.jisaCD AND a.deptCD = c.deptCD AND a.subj = c.subj
	LEFT JOIN (
		SELECT hkey, kwamok, MAX(omrDate) AS omrDate
		FROM globaldig.OmrGicho AS aa
		GROUP BY hkey
		ORDER BY omrDate DESC
	) AS d ON a.memKey = d.hkey AND a.subj = d.kwamok
	WHERE a.memKey = #{memKey} AND a.jisaCD = #{jisaCD} 
	<if test="deptCD != '00000'">
		AND b.deptCD = #{deptCD}
	</if>
	ORDER BY statusCD, subj DESC
	</select>
	<insert id="insertMemMstHisForGuadianInfo" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemMstHis 
		(memKey, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, registWhy, registWhyEtc, registHow, registHowEtc, remarks, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, registWhy, registWhyEtc, registHow, registHowEtc, remarks, regDate, regID, updDate, updID, '10', NOW(), #{workId}
	FROM globalbiz.MemMst
		<where>
			memKey IN 
			 <foreach item="item" index="index" collection="memKeys"
			     open="(" separator="," close=")">
			       #{item}
			 </foreach>
		</where>
	</insert>
	<update id="updateGuardianInfo" parameterType="hashMap">
	UPDATE globalbiz.MemMst 
	SET gFstName = #{guardianInfo.gFstName}, gLstName = #{guardianInfo.gLstName}, city = #{guardianInfo.city}, stateCD = #{guardianInfo.stateCD},
		zip = #{guardianInfo.zip}, addr = #{guardianInfo.addr}, gEmail = #{guardianInfo.gEmail}, gPhone = #{guardianInfo.gPhone},
		gCellPhone = #{guardianInfo.gCellPhone}, updDate=NOW(), updID=#{workId}
		<where>
			memKey IN 
			 <foreach item="item" index="index" collection="memKeys"
			     open="(" separator="," close=")">
			       #{item}
			 </foreach>
		</where>
	</update>
	<insert id="insertMemCommentCall" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemCommentCall 
		(callDate, memKey, memName, callNotes, jisaCD, deptCD, regDate, regID)
	VALUES (#{callDate}, #{memKey}, #{memName}, #{callNotes}, #{jisaCD}, #{deptCD}, NOW(), #{regID})
	</insert>
	<select id="getMemberSubjects" parameterType="java.lang.String" resultType="java.lang.String">
	SELECT subj 
	FROM globalbiz.MemSubjMst
	WHERE memKey = #{memKey} and statusCD = '1'
	ORDER BY subj DESC
	</select>
	<insert id="insertMemAppointment" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemAppointment 
		(apmRegistYMD, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, preferredYMD, preferredTimes, preferredNotes, apmStatusCD, subj, memKey, registYMD, freeDigYMD, deptCD, jisaCD, regDate, regID, updDate, updID)
	SELECT #{currentYMD}, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, #{preferredYMD}, #{preferredTimes}, #{preferredNotes}, '01', #{subj}, memKey, '', '', #{loginInfo.deptCD}, #{loginInfo.jisaCD}, NOW(), #{workId}, NOW(), #{workId}
	FROM globalbiz.MemMst
	WHERE memKey = #{memKey}
	</insert>
	<insert id="insertMemMstHisForMemberInfo" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemMstHis 
		(memKey, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, registWhy, registWhyEtc, registHow, registHowEtc, remarks, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, mFstName, mLstName, mBirthDay, gradeCD, schoolName, mEmail, eContact, ePhone, gFstName, gLstName, city, stateCD, zip, addr, gEmail, gPhone, gCellPhone, registWhy, registWhyEtc, registHow, registHowEtc, remarks, regDate, regID, updDate, updID, '10', NOW(), #{workId}
	FROM globalbiz.MemMst
	WHERE memKey = #{memMst.memKey}
	</insert>
	<update id="updateMemMst" parameterType="hashMap">
	UPDATE globalbiz.MemMst 
	SET mFstName = #{memMst.mFstName}, mLstName = #{memMst.mLstName}, mBirthDay = #{memMst.mBirthDay}, gradeCD = #{memMst.gradeCD},
		schoolName = #{memMst.schoolName}, mEmail = #{memMst.mEmail}, eContact = #{memMst.eContact}, ePhone = #{memMst.ePhone}, remarks = #{memMst.remarks},
		updDate=NOW(), updID=#{workId}
	WHERE memKey = #{memMst.memKey}
	</update>
	<update id="updateMemSubjMstForMemName" parameterType="hashMap">
	UPDATE globalbiz.MemSubjMst 
	SET memName = CONCAT(#{memMst.mFstName},' ',#{memMst.mLstName}), updDate=NOW(), updID=#{workId}
	WHERE memKey = #{memMst.memKey}
	</update>
	<select id="findMemberReportSubjStudys" parameterType="java.lang.String" resultType="com.jeiglobal.hk.domain.member.MemberDto$MemberReportSubjStudyInfo">
	SELECT a.memKey, a.subj, a.studyNum, a.bookNum, b.yoil, globalbiz.FuncCodeDtlNM(b.jisaCD, '0006', b.yoil, 'E', 'Y') AS yoilName, b.visitHours, globalbiz.FuncCodeDtlNM(b.jisaCD, '0206', b.visitHours, '', 'Y') AS visitHoursName
	FROM globalbiz.MemSubjMst AS a 
	INNER JOIN globalbiz.MemSubjStudy AS b ON a.memKey = b.memKey AND a.subj = b.subj 
	WHERE a.memKey = #{memKey} AND a.statusCD = '1'
	</select>
	<insert id="insertMemSubjMstHis" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjMstHis 
		(memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, '10', NOW(), #{workId}
	FROM globalbiz.MemSubjMst
	WHERE memKey = #{memKey} and subj = #{subj}
	</insert>
	<select id="findMemSubjStudyByMemKeyAndSubj" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemSubjStudy">
	SELECT *
	FROM globalbiz.MemSubjStudy
	WHERE memKey = #{memKey} AND subj = #{subj} AND yoilSeq = 1
	</select>
	<update id="updateMemSubjMstForStudyNum" parameterType="hashMap">
	UPDATE globalbiz.MemSubjMst 
	<set>
		<choose>
			<when test="type.equals('1'.toString())">
				befoYoil = yoil, yoil = #{yoil}, yoilChgYMD = #{currentYMD},
			</when>
			<when test="type.equals('2'.toString())">
				befoStudyNum = studyNum, studyNum = #{studyNum}, studyNumChgYMD = #{currentYMD},
			</when>
			<when test="type.equals('3'.toString())">
				befoYoil = yoil, yoil = #{yoil}, yoilChgYMD = #{currentYMD}, befoStudyNum = studyNum, studyNum = #{studyNum}, studyNumChgYMD = #{currentYMD},
			</when>
		</choose>
	updDate=NOW(), updID=#{workId}
	</set>
	WHERE memKey = #{memKey} AND subj = #{subj}
	</update>
	<insert id="insertMemSubjStudyHis" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjStudyHis 
		(memKey, subj, studyNum, bookNum, yoil, yoilSeq, bookFlag, visitHours, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, subj, studyNum, bookNum, yoil, yoilSeq, bookFlag, visitHours, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, '10', NOW(), #{workId}
	FROM globalbiz.MemSubjStudy
	WHERE memKey = #{memKey} and subj = #{subj} and yoilSeq = '1'
	</insert>
	<update id="updateMemSubjStudy" parameterType="hashMap">
	UPDATE globalbiz.MemSubjStudy 
	SET studyNum = #{studyNum}, yoil = #{yoil}, visitHours = #{manageTimes}, updDate=NOW(), updID=#{workId}
	WHERE memKey = #{memKey} and subj = #{subj} and yoilSeq = '1'
	</update>
	<insert id="insertMemSubjMstHisByDrop" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjMstHis 
		(memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, '14', NOW(), #{workId}
	FROM globalbiz.MemSubjMst
	WHERE memKey = #{memKey} and subj = #{subj}
	</insert>
	<update id="updateMemSubjMstByDrop" parameterType="hashMap">
	UPDATE globalbiz.MemSubjMst 
	SET statusCD = '2', dropFnlYMD = #{currentYMD}, updDate=NOW(), updID=#{workId}
	WHERE memKey = #{memKey} and subj = #{subj}
	</update>
	<insert id="insertMemSubjDrop" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjDrop
		(dropYMD, memKey, subj, memName, dropReason, notes, empKey, deptCD, jisaCD, regDate, regID)
	SELECT
		#{currentYMD}, #{memKey}, #{subj}, #{memName}, #{dropReason}, #{notes}, empKey, deptCD, jisaCD, NOW(), #{workId}
	FROM globalbiz.MemSubjMst
	WHERE memKey = #{memKey} AND subj = #{subj}
	</insert>
	<insert id="insertMemSubjMstHisByDropCancel" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjMstHis 
		(memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, hUpdCD, hRegDate, hRegID)
	SELECT memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID, '15', NOW(), #{workId}
	FROM globalbiz.MemSubjMst
	WHERE memKey = #{memKey} and subj = #{subj}
	</insert>
	<delete id="deleteMemSubjMstByDropCancel" parameterType="hashMap">
	DELETE 
	FROM globalbiz.MemSubjMst 
	WHERE memKey = #{memKey} and subj = #{subj}
	</delete>
	<insert id="insertMemSubjMstByDropCancel" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjMst 
		(memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID)
	SELECT memKey, subj, statusCD, memName, yoil, studyNum, bookNum, digGrade, registFstYMD, registFnlYMD, dropFnlYMD, expireYMD, feeFnlYMD, yoilChgYMD, studyNumChgYMD, bookNumChgYMD, befoYoil, befoStudyNum, befoBookNum, empKey, deptCD, jisaCD, regDate, regID, updDate, updID
	FROM globalbiz.MemSubjMstHis
	WHERE memKey = #{memKey} AND subj = #{subj} AND hUpdCD = '14'
	ORDER BY hRegDate DESC 
	LIMIT 0, 1 
	</insert>
	<insert id="insertMemSubjDropHisByDropCancel" parameterType="hashMap" useGeneratedKeys="true" keyProperty="idx">
	INSERT INTO globalbiz.MemSubjDropHis
		(hIdx, dropYMD, memKey, subj, memName, dropReason, notes, empKey, deptCD, jisaCD, regDate, regID, hRegDate, hRegID)
	SELECT
		idx, dropYMD, memKey, subj, memName, dropReason, notes, empKey, deptCD, jisaCD, regDate, regID, NOW(), #{workId}
	FROM globalbiz.MemSubjDrop
	WHERE memKey = #{memKey} AND subj = #{subj} AND dropYMD = #{convDropDate}
	ORDER BY regDate DESC
	LIMIT 0,1
	</insert>
	<delete id="deleteMemSubjDropByDropCancel" parameterType="hashMap">
	DELETE 
	FROM globalbiz.MemSubjDrop 
	WHERE memKey = #{memKey} AND subj = #{subj} AND dropYMD = #{convDropDate}
	ORDER BY regDate DESC
	LIMIT 1
	</delete>
	<delete id="deleteMemAppointment" parameterType="int">
	DELETE 
	FROM globalbiz.MemAppointment 
	WHERE idx = #{idx}
	</delete>
	<select id="findMemberIpprs" parameterType="java.lang.String" resultType="com.jeiglobal.hk.domain.member.MemberDto$MemberIpprInfo">
		SELECT a.memKey, a.subj, IFNULL(b.omrDate,'') AS omrDate, IFNULL(b.jisaCD,'') AS jisaCD, c.digYN
		FROM globalbiz.MemSubjMst AS a
		LEFT JOIN (
			SELECT hkey, kwamok, MAX(omrDate) AS omrDate, jisaCD
			FROM globaldig.OmrGicho
			GROUP BY hkey, kwamok
		) AS b ON a.memKey = b.hkey AND a.subj = b.kwamok
		INNER JOIN globalbiz.DeptSubjInfo AS c ON a.jisaCD = c.jisaCD AND a.deptCD = c.deptCD AND a.subj = c.subj
		WHERE a.memKey = #{memKey}
	</select>
	<select id="findMemCommentCallsCount" parameterType="java.lang.String" resultType="int">
	SELECT COUNT(1)
	FROM globalbiz.MemCommentCall
	WHERE memKey = #{memKey}
	</select>
	<select id="findMemCommentCalls" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.member.MemCommentCall">
	SELECT *
	FROM globalbiz.MemCommentCall
	WHERE memKey = #{memKey}
	ORDER BY callDate DESC, regDate DESC 
	LIMIT #{startRow},#{rowBlockSize}
	</select>
	<delete id="deleteCommentCall" parameterType="int">
	DELETE FROM globalbiz.MemCommentCall WHERE idx = #{idx}
	</delete>
</mapper>