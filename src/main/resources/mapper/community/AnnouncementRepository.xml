<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeiglobal.hk.repository.community.AnnouncementRepository">
	<select id="findTotalArticleCount" resultType="int">
		SELECT COUNT(*) FROM globalbiz.Announcement
		<where>
			boardDeleteYN = 'N'
			<if test="searchField != null and searchValue != ''">
				AND ${searchField} like CONCAT('%', #{searchValue}, '%')
			</if>
		</where>
	</select>
	
	<select id="findAnnouncements" parameterType="hashMap" resultType="com.jeiglobal.hk.domain.community.Announcement">
		SELECT boardIdx, memberId, boardSubject, boardContent, boardReadCount, DATE_FORMAT(boardRegDate, '%Y-%m-%d %H:%i') AS boardRegDate 
		FROM globalbiz.Announcement
		<where>
			boardDeleteYN = 'N'
			<if test="searchField != null and searchValue != ''">
				AND ${searchField} like CONCAT('%', #{searchValue}, '%')
			</if>
		</where>
		ORDER BY boardRegDate DESC, boardIdx DESC 
		LIMIT #{startRow}, #{endRow}
	</select>
	
	<select id="findAnnouncement" parameterType="int" resultType="com.jeiglobal.hk.domain.community.Announcement">
		SELECT boardIdx, memberId, boardSubject, boardContent, boardReadCount, DATE_FORMAT(boardRegDate, '%Y-%m-%d %H:%i') AS boardRegDate 
		FROM globalbiz.Announcement
		<where>
			boardIdx = #{idx} AND boardDeleteYN = 'N'
		</where>
	</select>
	
	<update id="updateAnnouncementReadCount">
		UPDATE globalbiz.Announcement SET boardReadCount = boardReadCount + 1
		<where>
			boardIdx = #{idx} AND boardDeleteYN = 'N'
		</where>
	</update>
	
	<insert id="insertAnnouncement" parameterType="com.jeiglobal.hk.domain.community.Announcement" useGeneratedKeys="true" keyProperty="boardIdx">
		INSERT INTO globalbiz.Announcement(memberId, boardKindCode, boardSubject, boardContent, boardDeleteYN, boardReadCount, boardRegDate) 
			VALUES(#{memberId}, '1', #{boardSubject}, #{boardContent}, 'N', 0, NOW())
	</insert>
	
	<update id="deleteAnnouncement">
		UPDATE globalbiz.Announcement SET boardDeleteYN = 'Y'
		<where>
			boardIdx = #{idx} AND boardDeleteYN = 'N'
		</where>
	</update>
	
	<update id="updateAnnouncement" parameterType="hashMap">
		UPDATE globalbiz.Announcement 
		SET boardSubject = #{announcement.boardSubject}, 
			boardContent = #{announcement.boardContent},
			boardUptDate = NOW()
		<where>
			boardIdx = #{idx}
		</where>
	</update>
	
	<insert id="insertAttachFile" parameterType="com.jeiglobal.hk.domain.community.AttachFile" useGeneratedKeys="true" keyProperty="fileIdx">
		INSERT INTO globalbiz.AttachFile(boardIdx, fileOriginalName, fileName, fileSize, fileUrl, fileExt, fileDownloadCount) 
			VALUES(#{boardIdx},#{fileOriginalName},#{fileName},#{fileSize},#{fileUrl},#{fileExt},#{fileDownloadCount})
	</insert>
	
	<select id="findAttachFiles" parameterType="int" resultType="com.jeiglobal.hk.domain.community.AttachFile">
		SELECT fileIdx, boardIdx, fileOriginalName, fileName, fileSize, fileUrl, fileExt, fileDownloadCount 
		FROM AttachFile
		<where>
			boardIdx = #{idx}
		</where>
	</select>
	
	<update id="updateFileDownloadCount" parameterType="int">
		UPDATE globalbiz.AttachFile 
		SET fileDownloadCount = fileDownloadCount + 1 
		<where>
			fileIdx = #{fileIdx}
		</where>
	</update>
	
	<select id="findAttachFile" parameterType="int" resultType="com.jeiglobal.hk.domain.community.AttachFile">
		SELECT fileIdx, boardIdx, fileOriginalName, fileName, fileSize, fileUrl, fileExt, fileDownloadCount 
		FROM globalbiz.AttachFile
		<where>
			fileIdx = #{fileIdx}
		</where>
	</select>
	
	<delete id="deleteAttachFileByFileIdx" parameterType="int">
		DELETE FROM globalbiz.AttachFile 
		<where>
			fileIdx = #{fileIdx}
		</where>
	</delete>
	
	<insert id="insertComment">
		INSERT INTO globalbiz.Comment(boardIdx, memberId, commentContent, commentDeleteYN, commentRegDate)
		VALUES(#{idx}, #{memberId}, #{content}, 'N', NOW())
	</insert>
	
	<select id="findCommentsByIdx" parameterType="int" resultType="com.jeiglobal.hk.domain.community.Comment">
		SELECT commentIdx, boardIdx, memberId, commentContent, DATE_FORMAT(commentRegDate, '%Y-%m-%d') AS commentRegDate
		FROM globalbiz.Comment
		<where>
			boardIdx = #{idx} AND commentDeleteYN = 'N'
		</where>
		ORDER BY commentRegDate DESC, commentIdx DESC
	</select>
	
	<update id="deleteCommentByCommentIdx" parameterType="int">
		UPDATE globalbiz.Comment 
		SET commentDeleteYN = 'Y' 
		<where>
			commentIdx = #{commentIdx}
		</where>
	</update>
	
	<update id="deleteCommentByBoardIdx" parameterType="int">
		UPDATE globalbiz.Comment 
		SET commentDeleteYN = 'Y' 
		<where>
			boardIdx = #{idx}
		</where>
	</update>
</mapper>